import numpy as np
import math
from scipy.sparse import csr_matrix, lil_matrix
from scipy.spatial import cKDTree

###########################################################################

def getWeights( z=0., x=np.arange(-3.,4.,1.), m=1 \
, phsDegree=5, polyDegree=3 ) :
    
    width = np.max(x) - np.min(x)
    
    x = ( x - z ) / width
    
    P = np.zeros(( len(x), polyDegree+1 ))
    for j in range(polyDegree+1) :
        P[:,j] = x**j
    
    xx,yy = np.meshgrid( x, x )
    A = np.vstack(( \
        np.hstack(( np.abs(xx-yy)**phsDegree, P )), \
        np.hstack(( np.transpose(P), np.zeros((polyDegree+1,polyDegree+1)) )) \
        ))
    
    b = np.array([])
    if m == 0 :
        b = np.abs(0.-x) ** phsDegree
    elif ( len(x) >= polyDegree+1 ) & ( phsDegree >= m+1 ) :
        if np.mod(m,2) == 0 :
            b = np.prod( np.arange(phsDegree-(m-1),phsDegree+1) ) \
            * np.abs(0.-x) ** (phsDegree-m)
        else :
            b = np.prod( np.arange(phsDegree-(m-1),phsDegree+1) ) \
            * (0.-x) ** (phsDegree-m) * np.sign(0.-x)
    
    p = np.zeros(( polyDegree + 1 ))
    if polyDegree >= m :
        p[m] = math.factorial(m)
    
    if b == np.array([]) :
        raise ValueError( "Bad parameters.  Choose values such that \
        len(x)>=polyDegree+1 and phsDegree>=m+1." )
    else :
        b = np.hstack(( b, p ))
        w = np.linalg.solve( A, b )
        w = w[0:len(x)]
    
    return w / width**m

###########################################################################

def getDM( x=np.arange(-1.,1.2,.2), X=np.arange(-.9,1.1,.2), m=0 \
, phsDegree=5, polyDegree=3, stencilSize=7 ) :
    
    ell = len(X)
    
    ii = np.transpose( np.tile( np.arange(0,ell), (stencilSize,1) ) )
    
    w  = np.zeros(( ell, stencilSize ))
    
    xNew = np.zeros(( len(x), 1 ))
    xNew[:,0] = x
    tree = cKDTree( xNew )
    
    Xnew = np.zeros(( ell, 1 ))
    Xnew[:,0] = X
    
    jj = tree.query( Xnew, stencilSize )
    jj = jj[1]
    
    # jj = tree.query( Xnew, 1 )
    # jj = jj[1]
    # jj = tree.query( xNew[jj,:], stencilSize )
    # jj = jj[1]
    
    for i in range(ell) :
        w[i,:] = getWeights( X[i], x[jj[i,:]], m, phsDegree, polyDegree )
    
    ii = ii.flatten()
    jj = jj.flatten()
    w  = w.flatten()
    
    W = csr_matrix( (w,(ii,jj)), [ell,len(x)] )
    
    return W

###########################################################################

def getPeriodicDM( period=2*np.pi, x='none', X='none', m=1 \
, phsDegree=5, polyDegree=3, stencilSize=7 ) :
    
    pad = np.int(np.round( (stencilSize-1)/2 ))
    
    x = np.hstack(( x[len(x)-pad:len(x)]-period, x, x[0:pad]+period ))
    
    W = getDM( x, X, m, phsDegree, polyDegree, stencilSize )
    
    W = lil_matrix( W )
    
    W[:,pad:2*pad]               = W[:,pad:2*pad]               + W[:,len(x)-pad:len(x)]
    W[:,len(x)-2*pad:len(x)-pad] = W[:,len(x)-2*pad:len(x)-pad] + W[:,0:pad]
    
    W = W[:,pad:len(x)-pad]
    
    W = csr_matrix(W)
    
    return W

###########################################################################
